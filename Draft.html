<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>No Consolation</title>
  <link rel="stylesheet" href="stylesspl.css" />
  <link
    rel="stylesheet"
    href="https://use.fontawesome.com/releases/v5.14.0/css/all.css"
    crossorigin="anonymous"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Kumbh+Sans:wght@400;700&display=swap"
    rel="stylesheet"
  />
  <style>
    /* Reset and body */
    body {
      font-family: 'Kumbh Sans', sans-serif;
      color: #a5a5a5;
      margin: 0;
      padding: 0 20px 40px;
    }

    /* Navbar and sub-navbar (assumed from your stylesheet, minimal override here) */
    .navbar {
      margin-bottom: 20px;
      height: 150px;
      padding: 20px 40px;
      display: flex;
    }




    /* Form label and selects */
    label {
      font-weight: 600;
      margin-right: 8px;
    }
    select {
      width: 180px;  /* fixed width so it doesn't shrink */
      min-width: 180px;
      padding: 6px 10px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      cursor: pointer;
      transition: border-color 0.2s ease;
    }

    select:focus {
      border-color: teal;
      outline: none;
      box-shadow: 0 0 5px teal;
    }


    /* Layout form */
    .form-row {
      margin: 0 auto 24px;
      max-width: 400px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px 12px;
      align-items: left;
      justify-content: space-between;
    }

    .form-row label {
      flex: 0 0 auto;
    }
    .form-row select {
      flex: 1 1 auto;
      min-width: 120px;
    }
  button[type="submit"] {
    display: block;
    margin: 30px auto 10px auto;
    padding: 16px 0;
    width: 250px; /* explicitly set width */
    font-size: 1.2rem;
    font-weight: bold;
    background: linear-gradient(135deg, #8e44ad, #50a5d5);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    transition: all 0.3s ease;
  }


  button[type="submit"]:hover {
    background: linear-gradient(135deg, #8e44ad, #50a5d5);
    transform: scale(1.05);
    box-shadow: 0 6px 14px rgba(0, 0, 0, 0.3);
  }
.dashboard-container {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  max-width: 1000px;
  margin: 40px auto;
  gap: 20px;
}

#budgetTable {
  flex: 0 0 300px;
  border-collapse: collapse;
  background-color: #f0f0f0;
  color: #333;
  font-size: 1rem;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

#budgetTable th, #budgetTable td {
  padding: 10px 15px;
  text-align: left;
}

#budgetTable thead th {
  background-color: #7f8c8d;
  color: #fff;
  font-weight: 600;
  border-bottom: 2px solid #555;
}

#budgetTable tbody tr {
  background-color: #f0f0f0;
  border-bottom: 1px solid #ccc;
}

#budgetTable th:nth-child(1),
#budgetTable td:nth-child(1) {
  width: 70%;
}

#budgetTable th:nth-child(2),
#budgetTable td:nth-child(2) {
  width: 30%;
  text-align: center;
}

@keyframes budgetUpdate {
  0% { background-color: #0c7925; }  /* light green start */
  100% { background-color: #f0f0f0; }
}

.highlight-row {
  animation: budgetUpdate 4s ease forwards;
}

.dashboard {
  max-width: 500px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  position: relative;
}

.player-card {
  max-width: 1000px;
  margin: 20px auto;
  padding: 15px 20px;
  background: #1a1a1a;
  border-radius: 12px;
  border: 2px solid #e74c3c;
  color: black;
  font-family: 'Kumbh Sans', sans-serif;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}
.player-card h2 {
  margin: 0 0 10px;
  font-size: 1.6rem;
  color: #e74c3c;
  text-align: center;
}
.player-card.restricted {
  border-color: #3498db;       /* blue border */
  color: black;                 /* white text for contrast */
}

.player-card.restricted h2 {
  color: #3498db;              /* header text blue */
}
.player-stats {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 8px;
  text-align: center;
}
.player-stats div {
  background: #f0f0f0;
  padding: 8px;
  border-radius: 6px;
  font-size: 0.9rem;
}

#draftedRostersContainer {
  max-width: 1000px;
  margin: 200px auto;
  padding: 25px 20px;
}

.drafted-rosters-table {
  width: 1000px;
  max-width: 100%;
  margin: 0 auto;
  table-layout: fixed; /* evenly spaced columns */
  border-collapse: collapse; /* needed for vertical borders */
  border-radius: 10px;
  overflow: hidden;
  background-color: #fff;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.drafted-rosters-table th,
.drafted-rosters-table td {
  padding: 4px 8px; /* more space vertically and horizontally */
  text-align: center;
  border-bottom: 1px solid #ccc; /* horizontal row separation */
  border-right: 1px solid #ccc;  /* vertical column separation */
  height: 30px; /* fixed row height for even spacing */
  box-sizing: border-box;
}

.drafted-rosters-table th:last-child,
.drafted-rosters-table td:last-child {
  border-right: none; /* remove border on last column */
}
.drafted-rosters-table tr:nth-child(4) td {
  border-top: 5px solid #a9a9a9; /* thick border between captains & sidekicks */
}

.drafted-rosters-table th {
  font-weight: 600;
  font-size: .8rem;
  color: #fff;
}

.drafted-rosters-table td {
  font-weight: 500;
  color: #333;
}


/* Rounded corners for top and bottom row */
.drafted-rosters-table thead th:first-child {
  border-top-left-radius: 10px;
}
.drafted-rosters-table thead th:last-child {
  border-top-right-radius: 10px;
}
.drafted-rosters-table tbody tr:last-child td:first-child {
  border-bottom-left-radius: 10px;
}
.drafted-rosters-table tbody tr:last-child td:last-child {
  border-bottom-right-radius: 10px;
}

.char-count-container {
  display: flex;
  flex-direction: column;  /* stack vertically */
  justify-content: center; /* optional: center the tables horizontally */
  align-items: center;     /* center horizontally */
  gap: 12px;               /* space between tables */
  margin: 20px auto;
}

.char-count-table {
  border-collapse: separate;
  border-spacing: 0;
  border-radius: 12px;
  overflow: hidden;
  width: 1000px;           /* same width for both tables */
  max-width: 90%;
  table-layout: fixed;      /* evenly distribute columns */
  text-align: center;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.char-count-table th,
.char-count-table td {
  border: 1px solid #ddd;
  padding: 10px;
  /* remove width: 40px; */
}


.char-count-table th {
  font-weight: 600;
  color: white;
}

/* Rounded corners for first and last rows/columns */
.char-count-table thead th:first-child {
  border-top-left-radius: 12px;
}
.char-count-table thead th:last-child {
  border-top-right-radius: 12px;
}
.char-count-table tbody tr:last-child td:first-child {
  border-bottom-left-radius: 12px;
}
.char-count-table tbody tr:last-child td:last-child {
  border-bottom-right-radius: 12px;
}
  </style>
</head>
<body>
<style>
.draft-form {
  max-width: 400px;
  padding: 20px;
  background: #1a1a1a;
  border-radius: 12px;
  color: #fff;
  font-family: 'Kumbh Sans', sans-serif;
  box-shadow: 0 8px 20px rgba(0,0,0,0.3);
}

.form-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
}

.coach-name {
  font-size: 1.2rem;
  font-weight: bold;
}

.change-coach-btn {
  background: #444;
  color: #fff;
  border: none;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.2s;
}

.change-coach-btn:hover {
  background: #666;
}

.bid-container {
  text-align: center;
  margin-bottom: 20px;
}

.bid-input {
  width: 100%;
  font-size: 2rem;
  padding: 15px;
  border-radius: 10px;
  border: none;
  text-align: center;
  box-sizing: border-box;
}

.submit-btn {
  width: 100%;
  padding: 15px;
  font-size: 1.5rem;
  font-weight: bold;
  color: white;
  background: linear-gradient(135deg, #8e44ad, #50a5d5);
  border: none;
  border-radius: 10px;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
}

.submit-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 6px 15px rgba(0,0,0,0.3);
}

/* highlight style for selected player */

#playerListContainer {
  flex: 0 0 250px;        /* fixed width for the column */
  max-height: 400px;      /* sets the scrollable height */
  overflow-y: auto;       /* makes it scrollable */
  border: 1px solid #ccc;
  border-radius: 8px;
  background: #f0f0f0;
  padding: 5px;
}

.submission-bubble {
  background-color: #c0392b;
  color: #fff;
  padding: 12px 20px;
  border-radius: 20px;
  font-weight: bold;
  font-size: 1.2rem;
  border: 2px solid #000;
  width: 200px;
  margin-bottom: 8px;
  opacity: 1;
  transform: translateX(0) scale(1); /* final state */
}

.new-bubble {
  animation: slideFadeScale 0.5s cubic-bezier(0.4,0,0.2,1) forwards;
}

@keyframes slideFadeScale {
  0% {
    transform: translateX(50%) scale(0.9);
    opacity: 0;
  }
  100% {
    transform: translateX(0) scale(1);
    opacity: 1;
  }
}

#globalTimer {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 20px; /* space between the two timers */
  margin: 40px auto;
}

/* Restricted Timer (blue) */
#restrictedTimerContainer {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-right: 20px; /* space from main timer */
}

#restrictedTimerLabel {
  font-size: 1rem;
  color: #3498db;
  font-weight: bold;
  margin-bottom: 5px;
}

#restrictedTimerClock {
  font-size: 3rem;
  font-weight: bold;
  color: white;
  padding: 15px 30px;
  border-radius: 20px;
  border: 3px solid #3498db; /* blue outline */
  text-shadow:
    -2px -2px 0 #3498db,
     2px -2px 0 #3498db,
    -2px  2px 0 #3498db,
     2px  2px 0 #3498db;
  display: inline-block;
  background-color: transparent; /* remove background */
}

/* Main timer formatting (restore your old red styling) */
#timerClock {
  font-size: 4rem;
  font-weight: bold;
  color: white;
  text-shadow:
    -2px -2px 0 #e74c3c,
     2px -2px 0 #e74c3c,
    -2px  2px 0 #e74c3c,
     2px  2px 0 #e74c3c;
  margin-top: 10px;
  background-color: rgba(0,0,0,0.5);
  padding: 20px 40px;
  border-radius: 20px;
  display: inline-block;
  border: 2px solid #e74c3c;
}

#submitBidBtn:disabled {
  background: #999 !important;  /* darker grey */
  color: #eee !important;            /* lighter text for contrast */
  cursor: not-allowed !important;
  opacity: 0.6 !important;           /* semi-transparent */
  border: 2px solid #666 !important; /* optional: darker border */
}

#playerTable {
  width: 100%;
  border-collapse: collapse;
  background: #f0f0f0; /* dark background to match site */
  color: #333;
  border: 1px solid #444;
  border-radius: 8px;
  overflow: hidden;
}

#playerTable th {
  background: var(--header-color); /* will match dropdown color */
  color: white;
  text-align: left;
  padding: 10px;
}

#playerTable td {
  border-bottom: 1px solid #444;
  padding: 5px;
}
/* highlight style for selected player */
#playerTable tbody tr.selected {
  background: linear-gradient(135deg, #50a5d5, #8e44ad);
  color: #fff;
  font-weight: bold;
}
#playerTable tbody tr {
  cursor: pointer;
  transition: background 0.2s;
}
#playerTable tbody tr:hover {
  background: #949494;
}

</style>

<nav class="navbar">
  <div class="navbar__container">
    <a href="/" id="navbar__logo"><i class="fas fa-gem"></i>NC</a>
    <div id="globalTimer" class="global-timer">
      
      <!-- Restricted timer -->
      <div id="restrictedTimerContainer">
        <div id="restrictedTimerLabel">Unlock Timer</div>
        <div id="restrictedTimerClock">0:30</div>
      </div>

      <!-- Main timer -->
      <div id="timerContainer">
        <div id="timerClock">0:00</div>
      </div>

    </div>
  </div>
</nav>




<div id="charCountContainer" class="char-count-container">
  <!-- JS will append two tables here -->
</div>


<div id="draftedRostersContainerDrafter"></div>
<div id="showSelectedPlayer" class="player-card" style="display:none;"></div>


<div class="dashboard-container">
    <div id="playerListContainer">
      <table id="playerTable">
        <thead>
          <tr>
            <th>Players</th>
          </tr>
        </thead>
        <tbody id="playerList"></tbody>
      </table>

  </div>
  <table id="budgetTable">
    <thead>
      <tr>
        <th>Coach</th>
        <th>Budget</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div id="commishBoard" class="dashboard"></div>
<form id="draftForm" class="draft-form">
  <div class="form-header">
    <div id="coachContainer" class="coach-name"></div>
    <button type="button" id="changeCoachBtn" class="change-coach-btn">Change Coach</button>
  </div>

  <div class="bid-container">
    <input type="number" id="bid" placeholder="Enter your bid" required min="0" class="bid-input">
  </div>


  <button type="submit" class="submit-btn" id="submitBidBtn">Submit</button>
</form>
  <div class="bids-column">
    <div id="DraftBidBoard" class="dashboard" style="min-height: 50px;"></div>
    </div>
  </div>

</div>





<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBdFLO9Pt8toDPfq3VUFEjMSfghi47tdio",
  authDomain: "spldraft.firebaseapp.com",
  databaseURL: "https://spldraft-default-rtdb.firebaseio.com",
  projectId: "spldraft",
  storageBucket: "spldraft.firebasestorage.app",
  messagingSenderId: "151054562933",
  appId: "1:151054562933:web:a294092e46475fa3c",
  measurementId: "G-V8H70EEQTC"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// --- Elements ---
const coachContainer = document.getElementById("coachContainer");
const changeCoachBtn = document.getElementById("changeCoachBtn");
const draftForm = document.getElementById("draftForm");
const bidInput = document.getElementById("bid");
const submitBidBtn = document.getElementById("submitBidBtn");
const draftedContainer = document.getElementById("draftedRostersContainerDrafter");
const charCountContainer = document.getElementById("charCountContainer");
const bidsContainer = document.getElementById("DraftBidBoard");
const selectedPlayerDiv = document.getElementById("showSelectedPlayer");
const timerClock = document.getElementById("timerClock");
const timerPlayer = document.getElementById("timerPlayer");
const playerListBody = document.getElementById("playerList");

// --- Coach Selection ---
let coach = localStorage.getItem("lastCoach");
  const COACHES = { 
    SPL: [
      "Austin","Dave","Eric","Garrett","Reid","Colin"
    ],
    MLS: ["Hamilton","Jaco","Danny","Tanya","Jake","Freddy"]
  };
function showDropdown() {
  coachContainer.innerHTML = `
    <label for="coach">Coach:</label>
    <select id="coach" required>
      <option value="">-- Select Coach --</option>
      <option value="Austin">Austin</option>
      <option value="Colin">Colin</option>
      <option value="Danny">Danny</option>
      <option value="Dave">Dave</option>
      <option value="Eric">Eric</option>
      <option value="Freddy">Freddy</option>
      <option value="Garrett">Garrett</option>
      <option value="Hamilton">Hamilton</option>
      <option value="Jaco">Jaco</option>
      <option value="Jake">Jake</option>
      <option value="Reid">Reid</option>
      <option value="Tanya">Tanya</option>
    </select>
  `;

  const coachSelect = document.getElementById("coach");
  coachSelect.addEventListener("change", () => {
    if (coachSelect.value) {
      coach = coachSelect.value;
      localStorage.setItem("lastCoach", coach);
      coachContainer.innerHTML = `Coach: <strong>${coach}</strong>`;
    }
  });
}

if (coach) {
  coachContainer.innerHTML = `Coach: <strong>${coach}</strong>`;
} else {
  showDropdown();
}

changeCoachBtn.addEventListener("click", () => {
  localStorage.removeItem("lastCoach");
  coach = null;
  showDropdown();
});

// --- Draft Form Submission ---
draftForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  if (!coach) return alert("Please select a coach!");

  const bid = Number(bidInput.value);
  if (bidInput.value === "" || isNaN(bid)) return alert("Please enter a bid!");

  try {
    // Get the selected player
    const selSnap = await get(ref(db, "selectedPlayer"));
    if (!selSnap.exists()) return alert("No player selected!");
    const sel = selSnap.val();
    const playerSnap = await get(ref(db, `players/${sel.league}/${sel.name}`));
    if (!playerSnap.exists()) return alert("Player not found!");

    const player = playerSnap.val();

    // Check if player is restricted
    if (player.status === "Restricted") {
      const minBid = Math.ceil(player.price * 1.1)+1 ;
      if (bid < minBid) {
        return alert(`This player is restricted! Minimum bid: ${minBid}`);
      }
    }

    // Save bid
    const coachDraftRef = ref(db, `bids/${coach}`);
    const snapshot = await get(coachDraftRef);
    const bidNumber = snapshot.exists() ? Object.keys(snapshot.val()).length + 1 : 1;
    const draftKey = `bid${bidNumber}`;
    await set(ref(db, `bids/${coach}/${draftKey}`), { bid, timestamp: Date.now() });

    draftForm.reset();
  } catch (err) {
    console.error("Firebase error:", err);
  }
});


// --- League ---
const leagueRef = ref(db, "currentLeague");
const leagueColors = { "": "#7f8c8d", "SPL": "orangered", "MLS": "teal" };
let currentPlayersListener = null;

// --- Drafted Table ---
function renderDraftedTableFull(coaches, playersData, league) {
  draftedContainer.innerHTML = "";

  // Map each coach to their captains and sidekicks
  const teamMap = {};
  Object.entries(playersData).forEach(([name, p]) => {
    if (!p.team) return;
    if (!teamMap[p.team]) teamMap[p.team] = { captains: [], sidekicks: [] };
    if (p.role === "Captain") teamMap[p.team].captains.push({ name, ...p });
    else teamMap[p.team].sidekicks.push({ name, ...p });
  });

  const table = document.createElement("table");
  table.className = "drafted-rosters-table";

  // Header
  const thead = document.createElement("thead");
  const headerRow = document.createElement("tr");
  coaches.forEach(c => {
    const th = document.createElement("th");
    th.textContent = c;
    headerRow.appendChild(th);
  });
  headerRow.style.backgroundColor = leagueColors[league] || "#7f8c8d";
  headerRow.style.color = "#fff";
  thead.appendChild(headerRow);
  table.appendChild(thead);

  // 2 rows for captains, 5 rows for sidekicks
  for (let row = 0; row < 7; row++) {
    const tr = document.createElement("tr");

    coaches.forEach(coach => {
      const td = document.createElement("td");
      const team = teamMap[coach] || { captains: [], sidekicks: [] };
      let player;

      if (row < 2) {
        // First 2 rows = captains
        player = team.captains[row];
      } else {
        // Next 5 rows = sidekicks
        player = team.sidekicks[row - 2];
      }

      if (player) {
        td.textContent = player.name;
        if (player.status === "Restricted") {
          td.innerHTML = `${player.name} - <b>${Math.ceil(player.price*1.1)}</b>`;
          td.style.color = "#3498db";
        } else td.style.color = "#000";
      }

      tr.appendChild(td);
    });

    table.appendChild(tr);
  }

  draftedContainer.appendChild(table);
}


// --- Firebase Listener for Players ---
onValue(leagueRef, (snapshot) => {
  const league = snapshot.val();
  if (!league) return;
  playerTable.style.setProperty("--header-color", leagueColors[league] || "#7f8c8d");
  if (currentPlayersListener) currentPlayersListener();

  const playersRef = ref(db, `players/${league}`);
  currentPlayersListener = onValue(playersRef, (snap) => {
    const playersData = snap.val();
    if (!playersData) return;

    const coaches = COACHES[league];


    // --- Render tables ---
    renderDraftedTableFull(coaches, playersData, league);
    renderCharCountTables(playersData);
    renderPlayersTable(playersData, league);

    // --- Render budget table ---
    const budgets = calculateBudgets(COACHES[league], playersData);
    renderBudgetTable(budgets);
  });
});


// --- Character Count Tables ---
const charOrder = ["BJ","Bowser","Daisy","Diddy","DK","Luigi","Mario","Peach","Petey","Wario","Waluigi","Yoshi","Birdo","Dry Bones","Boo","Koopa","Hammer Bro","Monty","Shy Guy","Toad"];

function renderCharCountTables(playersData) {
  if (!charCountContainer) return;
  const counts = {};
  Object.values(playersData)
  .filter(p => p.status !== "Locked") // skip Locked players
  .forEach(p => counts[p.char || "Unknown"] = (counts[p.char] || 0) + 1);


  const halves = [charOrder.slice(0,12), charOrder.slice(12)];
  charCountContainer.innerHTML = "";

  halves.forEach((group, idx) => {
    const table = document.createElement("table");
    table.className = "char-count-table";
    const thead = document.createElement("thead");
    const trHead = document.createElement("tr");
    const color = idx===0?"#e74c3c":"#3498db";
    group.forEach(char => { const th = document.createElement("th"); th.textContent=char; th.style.backgroundColor=color; trHead.appendChild(th); });
    thead.appendChild(trHead); table.appendChild(thead);

    const trBody = document.createElement("tr");
    group.forEach(char => { const td = document.createElement("td"); td.textContent = counts[char]||0; trBody.appendChild(td); });
    const tbody = document.createElement("tbody"); tbody.appendChild(trBody); table.appendChild(tbody);
    charCountContainer.appendChild(table);
  });
}

// --- Live Bids ---
let previousBids = new Set();
onValue(ref(db,"bids"), snapshot => {
  bidsContainer.innerHTML = "";
  if (!snapshot.exists()) return;
  const allBids = [];
  const drafts = snapshot.val();
  for (const coach in drafts) {
    for (const key in drafts[coach]) {
      allBids.push({ coach, bid: drafts[coach][key].bid, timestamp: drafts[coach][key].timestamp, id:`${coach}_${key}`});
    }
  }
  allBids.sort((a,b)=> b.bid-a.bid || a.timestamp-b.timestamp);

  allBids.forEach(({coach,bid,id})=>{
    const bubble = document.createElement("div");
    bubble.className="submission-bubble";
    bubble.textContent=`${coach} - ${bid} ðŸŸ¡`;
    bidsContainer.appendChild(bubble);
    if(!previousBids.has(id)) { previousBids.add(id); requestAnimationFrame(()=>bubble.classList.add("new-bubble")); }
  });
});

// --- Selected Player Stats ---
const selectedPlayerRef = ref(db,"selectedPlayer");
onValue(selectedPlayerRef, async snapshot => {
  const sel = snapshot.val();
  if (!sel) { 
    selectedPlayerDiv.style.display = "none"; 
    return; 
  }

  try {
    const playerSnap = await get(ref(db, `players/${sel.league}/${sel.name}`));
    if (!playerSnap.exists()) { 
      selectedPlayerDiv.style.display = "none"; 
      return; 
    }

    const stats = playerSnap.val();
    selectedPlayerDiv.style.display = "block";

    // Toggle restricted class
    if (stats.status === "Restricted") {
      selectedPlayerDiv.classList.add("restricted");
    } else {
      selectedPlayerDiv.classList.remove("restricted");
    }

    // Build the HTML
    let restrictedLine = "";
    if (stats.status === "Restricted") {
      // Price with ðŸŸ¡ emoji, rounded if needed
      const price = stats.price || 0;
      restrictedLine = `<div style="margin-top:4px; font-size:30px; text-align:center; font-weight:bold; color:#ffd700;">
                          Restricted: ${stats.team || "Unknown"} - Min Bid: ðŸŸ¡${Math.ceil(stats.price * 1.1)}
                        </div>`;

    }

    selectedPlayerDiv.innerHTML = `
      <h2>${sel.name} - Career Stats</h2>
      ${restrictedLine}
      <div class="player-stats">
        <div><u>Games</u><br>${stats.games}</div>
        <div><u>Win %</u><br>${stats.winp}</div>
        <div><u>Goals/Game</u><br>${stats.goals}</div>
        <div><u>MS-SS/Game</u><br>${stats.msss}</div>
        <div><u>SI</u><br>${stats.si}</div>
        <div><u>Impact</u><br>${stats.impact}</div>
        <div><u>+/-</u><br>${stats.pm}</div>
      </div>
    `;
  } catch (err) {
    console.error(err);
    selectedPlayerDiv.style.display = "none";
  }
});




// --- Calculate budgets for each coach ---
function calculateBudgets(coaches, playersData) {
  const maxBudget = 105; // or whatever your starting budget is
  const budgets = {};
  
  coaches.forEach(coach => {
    // Sum all drafted player prices for this coach
    const spent = Object.values(playersData)
      .filter(p => p.team === coach && p.price)
      .reduce((sum, p) => sum + Number(p.price || 0), 0);
    
    budgets[coach] = maxBudget - spent; // remaining budget
  });

  return budgets;
}

// --- Render budget table ---
const budgetTableBody = document.querySelector("#budgetTable tbody");
function renderBudgetTable(budgets) {
  budgetTableBody.innerHTML = "";
  Object.entries(budgets)
    .sort((a,b)=>b[1]-a[1]) // highest budget first
    .forEach(([coach, budget])=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${coach}</td><td>${budget}</td>`;
      budgetTableBody.appendChild(tr);
    });
}

const countdownSeconds = 60;
const RESTRICTED_WINDOW = 30;

let timerInterval = null;
let restrictedStart = null;

onValue(ref(db, "timer"), async (snapshot) => {
  const data = snapshot.val();

  if (!data || !data.running) {
    // Reset display
    submitBidBtn.disabled = true;
    document.getElementById("timerClock").textContent = countdownSeconds;
    document.getElementById("restrictedTimerContainer").style.display = "none";

    if (timerInterval) clearInterval(timerInterval);
    timerInterval = null;
    return;
  }

  submitBidBtn.disabled = false;
  
  const start = data.startTime;
  restrictedStart = start; // sync restricted timer with main timer start

  if (timerInterval) clearInterval(timerInterval);

  timerInterval = setInterval(async () => {
    const now = Date.now();
    const elapsed = Math.floor((now - start) / 1000);
    let mainRemaining = countdownSeconds - elapsed;
    if (mainRemaining < 0) mainRemaining = 0;

    // Update main timer
    document.getElementById("timerClock").textContent = mainRemaining;

    // Check current player
    const selSnap = await get(ref(db, "selectedPlayer"));
    if (!selSnap.exists()) return;
    const sel = selSnap.val();

    const playerSnap = await get(ref(db, `players/${sel.league}/${sel.name}`));
    if (!playerSnap.exists()) return;
    const player = playerSnap.val();

    // ---- RESTRICTED LOGIC ----
    if (player.status === "Restricted") {
      const restrictedElapsed = elapsed; // same base as main timer
      let restrictedRemaining = RESTRICTED_WINDOW - restrictedElapsed;
      if (restrictedRemaining < 0) restrictedRemaining = 0;

      document.getElementById("restrictedTimerContainer").style.display = "flex";
      document.getElementById("restrictedTimerClock").textContent = restrictedRemaining + "s";

      const bidSnap = await get(ref(db, "bids"));
      const hasAnyBid = bidSnap.exists() && Object.keys(bidSnap.val() || {}).length > 0;

      if (restrictedRemaining === 0 && !hasAnyBid) {
        await update(ref(db, `players/${sel.league}/${sel.name}`), { status: "Locked" });
        await update(ref(db, "timer"), { running: false }); // stop main timer
        document.getElementById("restrictedTimerContainer").style.display = "none";
        clearInterval(timerInterval);
      }

      if (hasAnyBid) {
        document.getElementById("restrictedTimerContainer").style.display = "none";
      }
    } else {
      document.getElementById("restrictedTimerContainer").style.display = "none";
    }

    // Stop main timer if it reaches 0
    if (mainRemaining === 0) {
      clearInterval(timerInterval);
      timerInterval = null;
    }

  }, 1000);
});

function renderPlayersTable(playersData, league) {
  playerListBody.innerHTML = "";

  const playersArray = Object.entries(playersData)
    .map(([name, stats]) => ({ name, ...stats }))
    .sort((a, b) => (a.order || 0) - (b.order || 0));

  playersArray.forEach(player => {
    const tr = document.createElement("tr");

    const nameTd = document.createElement("td");
    nameTd.textContent = player.name;

    tr.appendChild(nameTd);
    playerListBody.appendChild(tr);
  });
}


</script>


