<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>No Consolation</title>
  <link rel="stylesheet" href="stylesspl.css" />
  <link
    rel="stylesheet"
    href="https://use.fontawesome.com/releases/v5.14.0/css/all.css"
    crossorigin="anonymous"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Kumbh+Sans:wght@400;700&display=swap"
    rel="stylesheet"
  />
  <style>
    /* Reset and body */
    body {
      font-family: 'Kumbh Sans', sans-serif;
      color: #a5a5a5;
      margin: 0;
      padding: 0 20px 40px;
    }

    /* Navbar and sub-navbar (assumed from your stylesheet, minimal override here) */
    .navbar {
      margin-bottom: 20px;
      height: 150px;
      padding: 20px 40px;
      display: flex;
    }




    /* Form label and selects */
    label {
      font-weight: 600;
      margin-right: 8px;
    }
    select {
      width: 180px;  /* fixed width so it doesn't shrink */
      min-width: 180px;
      padding: 6px 10px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      cursor: pointer;
      transition: border-color 0.2s ease;
    }

    select:focus {
      border-color: white;
      outline: none;
      box-shadow: 0 0 5px white;
    }


    /* Layout form */
    .form-row {
      margin: 0 auto 24px;
      max-width: 400px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px 12px;
      align-items: left;
      justify-content: space-between;
    }

    .form-row label {
      flex: 0 0 auto;
    }
    .form-row select {
      flex: 1 1 auto;
      min-width: 120px;
    }
.dashboard-header {
  display: flex;
  justify-content: flex-end;
  margin: 20px;
}

#dashboardDropdown {
  padding: 6px 12px;
  font-size: 1rem;
  border-radius: 6px;
  border: 1px solid #000;
  color: #fff;
  cursor: pointer;
  transition: background 0.3s;
}

/* default background */
#dashboardDropdown.default {
  background-color: #7f8c8d; /* grey for unselected */
}

#draftedRostersContainer {
  max-width: 1240px;
  margin: 20px auto;
  padding: 0 20px;
}

.drafted-rosters-table {
  width: 100%;
  table-layout: fixed; /* evenly spaced columns */
  border-collapse: collapse; /* needed for vertical borders */
  border-radius: 10px;
  overflow: hidden;
  background-color: #fff;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.drafted-rosters-table th,
.drafted-rosters-table td {
  padding: 4px 8px; /* more space vertically and horizontally */
  text-align: center;
  border-bottom: 1px solid #ccc; /* horizontal row separation */
  border-right: 1px solid #ccc;  /* vertical column separation */
  height: 30px; /* fixed row height for even spacing */
  box-sizing: border-box;
}

.drafted-rosters-table th:last-child,
.drafted-rosters-table td:last-child {
  border-right: none; /* remove border on last column */
}
.drafted-rosters-table tr:nth-child(4) td {
  border-top: 5px solid #a9a9a9; /* thick border between captains & sidekicks */
}

.drafted-rosters-table th {
  font-weight: 600;
  font-size: .8rem;
  color: #fff;
}

.drafted-rosters-table td {
  font-weight: 500;
  color: #333;
}


/* Rounded corners for top and bottom row */
.drafted-rosters-table thead th:first-child {
  border-top-left-radius: 10px;
}
.drafted-rosters-table thead th:last-child {
  border-top-right-radius: 10px;
}
.drafted-rosters-table tbody tr:last-child td:first-child {
  border-bottom-left-radius: 10px;
}
.drafted-rosters-table tbody tr:last-child td:last-child {
  border-bottom-right-radius: 10px;
}
.char-count-container {
  display: flex;
  flex-direction: column;  /* stack vertically */
  justify-content: center; /* optional: center the tables horizontally */
  align-items: center;     /* center horizontally */
  gap: 12px;               /* space between tables */
  margin: 20px auto;
}

.char-count-table {
  border-collapse: separate;
  border-spacing: 0;
  border-radius: 12px;
  overflow: hidden;
  width: 1000px;           /* same width for both tables */
  max-width: 90%;
  table-layout: fixed;      /* evenly distribute columns */
  text-align: center;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.char-count-table th,
.char-count-table td {
  border: 1px solid #ddd;
  padding: 10px;
  /* remove width: 40px; */
}


.char-count-table th {
  font-weight: 600;
  color: white;
}

/* Rounded corners for first and last rows/columns */
.char-count-table thead th:first-child {
  border-top-left-radius: 12px;
}
.char-count-table thead th:last-child {
  border-top-right-radius: 12px;
}
.char-count-table tbody tr:last-child td:first-child {
  border-bottom-left-radius: 12px;
}
.char-count-table tbody tr:last-child td:last-child {
  border-bottom-right-radius: 12px;
}


  </style>
</head>

<style>
    .right-dashboard {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.dashboard-container {
  display: flex;
  gap: 20px;
  align-items: flex-start;
  max-width: 1200px;
  margin: 40px auto;
}
#budgetTable {
  flex: 0 0 300px; /* fixed width */
}

#commishBoard {
  flex: 1 1 auto; /* fill remaining space */
}
.dashboard {
  max-width: 500px;
  margin: 40px auto;
  display: flex;
  flex-direction: column;
  gap: 12px;
  position: relative;
}

.submission-bubble {
  background-color: #c0392b;
  color: #fff;
  padding: 12px 20px;
  border-radius: 20px;
  font-weight: bold;
  font-size: 1.2rem;
  border: 2px solid #000;
  transition: transform 0.4s ease;
  opacity: 1;
  width: 400px;
}

.new-bubble {
  transform: translateX(50%) scale(0.9); /* start slightly right and smaller */
  opacity: 0;
  animation: slideFadeScale 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
}

@keyframes slideFadeScale {
  to {
    transform: translateX(0) scale(1); /* final position and normal size */
    opacity: 1;
  }
}


.submit-btn {
  display: block;
  margin: 20px auto;
  padding: 15px;
  font-size: 1.2rem;
  border-radius: 10px;
  border: 2px solid #000;
  cursor: pointer;
  background: linear-gradient(135deg, #c0392b, #e74c3c);
  color: #fff;
  transition: transform 0.2s, box-shadow 0.2s, background 0.3s;
}

.submit-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 6px 15px rgba(0,0,0,0.3);
  background: linear-gradient(135deg, #e74c3c, #c0392b);
}

#budgetTable {
  width: 300px;
  border-collapse: collapse;
  margin: 0;
  background-color: #f0f0f0; /* light grey table background */
  color: #333;
  font-size: 1rem;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

#budgetTable th, #budgetTable td {
  padding: 10px 15px;
  text-align: left;
}

#budgetTable thead th {
  background-color: #7f8c8d; /* default dropdown grey */
  color: #fff;
  font-weight: 600;
  border-bottom: 2px solid #555;
}

#budgetTable tbody tr {
  background-color: #f0f0f0;
  border-bottom: 1px solid #ccc;
}


#budgetTable th:nth-child(1),
#budgetTable td:nth-child(1) {
  width: 50%;
}

#budgetTable th:nth-child(2),
#budgetTable td:nth-child(2) {
  width: 50%;
  text-align: center; /* optional for budget values */
}

@keyframes budgetUpdate {
  0% { background-color: #0c7925; }  /* light green start */
  100% { background-color: #f0f0f0; }   /* normal table row background */
}

.highlight-row {
  animation: budgetUpdate 4s ease forwards;
}
#playerTable {
  width: 100%;
  border-collapse: collapse;
  background: #f0f0f0; /* dark background to match site */
  color: #333;
  border: 1px solid #444;
  border-radius: 8px;
  overflow: hidden;
}

#playerTable th {
  background: var(--header-color); /* will match dropdown color */
  color: white;
  text-align: left;
  padding: 10px;
}

#playerTable td {
  border-bottom: 1px solid #444;
  padding: 5px;
}
/* highlight style for selected player */
#playerTable tbody tr.selected {
  background: linear-gradient(135deg, #50a5d5, #8e44ad);
  color: #fff;
  font-weight: bold;
}
#playerTable tbody tr {
  cursor: pointer;
  transition: background 0.2s;
}
#playerTable tbody tr:hover {
  background: #949494;
}
.player-card {
  max-width: 1000px;
  margin: 20px auto;
  padding: 15px 20px;
  background: #1a1a1a;
  border-radius: 12px;
  border: 2px solid #e74c3c;
  color: black;
  font-family: 'Kumbh Sans', sans-serif;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}
.player-card h2 {
  margin: 0 0 10px;
  font-size: 1.6rem;
  color: #e74c3c;
  text-align: center;
}
/* Restricted player variant */
.player-card.restricted {
  border-color: #3498db;       /* blue border */
  color: black;                 /* white text for contrast */
}

.player-card.restricted h2 {
  color: #3498db;              /* header text blue */
}

.player-stats {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 8px;
  text-align: center;
}
.player-stats div {
  background: #f0f0f0;
  padding: 8px;
  border-radius: 6px;
  font-size: 0.9rem;
}
/* Player list column */
#playerListContainer {
  flex: 0 0 250px;
  max-height: 600px;
  overflow-y: auto;
}

/* Column 2: Budget + button */
.budget-column {
  flex: 0 0 300px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

/* Column 3: Bids + input */
.bids-column {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

/* Budget table */
#budgetTable {
  width: 100%;
  border-collapse: collapse;
}

#budgetTable th, #budgetTable td {
  padding: 10px 15px;
  text-align: left;
}

/* Live bid feed */


/* Save & Clear button */
#saveClearBtn {
  padding: 12px;
  width: 400px;
  font-size: 1.1rem;
  font-weight: bold;
  cursor: pointer;
  border: none;
  border-radius: 8px;
  background: linear-gradient(135deg, #8e44ad, #50a5d5);
  color: white;
  transition: transform 0.2s, box-shadow 0.2s;
}

#saveClearBtn:hover {
  transform: scale(1.05);
  box-shadow: 0 6px 15px rgba(0,0,0,0.3);
}
/* Highlight winning coach */
.highlight-row {
  animation: budgetUpdate 2s ease forwards;
}

@keyframes budgetUpdate {
  0% { background-color: #0c7925; color: #fff; }
  100% { background-color: #f0f0f0; color: #333; }
}

/* Optional: smooth row transition */
#budgetTable tbody tr {
  transition: all 0.5s ease;
}


/* Make the control column as small as possible */
#playerTable th:last-child,
#playerTable td:last-child {
  width: 1%;
  white-space: nowrap;
  text-align: right;
}

/* Push the Start button fully right */
.start-btn {
  margin-left: auto;
}

#globalTimer {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 20px; /* space between the two timers */
  margin: 40px auto;
}

/* Restricted Timer (blue) */
#restrictedTimerContainer {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-right: 20px; /* space from main timer */
}

#restrictedTimerLabel {
  font-size: 1rem;
  color: #3498db;
  font-weight: bold;
  margin-bottom: 5px;
}

#restrictedTimerClock {
  font-size: 3rem;
  font-weight: bold;
  color: white;
  padding: 15px 30px;
  border-radius: 20px;
  border: 3px solid #3498db; /* blue outline */
  text-shadow:
    -2px -2px 0 #3498db,
     2px -2px 0 #3498db,
    -2px  2px 0 #3498db,
     2px  2px 0 #3498db;
  display: inline-block;
  background-color: transparent; /* remove background */
}

/* Main timer formatting (restore your old red styling) */
#timerClock {
  font-size: 4rem;
  font-weight: bold;
  color: white;
  text-shadow:
    -2px -2px 0 #e74c3c,
     2px -2px 0 #e74c3c,
    -2px  2px 0 #e74c3c,
     2px  2px 0 #e74c3c;
  margin-top: 10px;
  background-color: rgba(0,0,0,0.5);
  padding: 20px 40px;
  border-radius: 20px;
  display: inline-block;
  border: 2px solid #e74c3c;
}



</style>
<body>

  <!-- Navbar Section -->
<nav class="navbar">
  <div class="navbar__container">
    <a href="/" id="navbar__logo"><i class="fas fa-gem"></i>NC</a>
    <div id="globalTimer" class="global-timer">
      
      <!-- Restricted timer -->
      <div id="restrictedTimerContainer">
        <div id="restrictedTimerLabel">Unlock Timer</div>
        <div id="restrictedTimerClock">0:30</div>
      </div>

      <!-- Main timer -->
      <div id="timerContainer">
        <div id="timerPlayer"></div>
        <div id="timerClock">0:00</div>
      </div>

    </div>
  </div>
</nav>



</div>

    
    </div>
  </nav>


<!-- Dashboard Dropdown -->
<div class="dashboard-header">
  <div id="dashboardDropdownContainer">
    <select id="dashboardDropdown">
      <option value="">--</option>
      <option value="SPL">SPL</option>
      <option value="MLS">MLS</option>
    </select>
  </div>
</div>

<!-- Selected player card -->
<div id="showSelectedPlayer" class="player-card" style="display:none;"></div>

<div id="charCountContainer" class="char-count-container">
  <!-- JS will append two tables here -->
</div>
<div id="draftedRostersContainer"></div>



<!-- Dashboard container: three columns -->
<!-- Dashboard container: three columns -->
<div class="dashboard-container">

  <!-- Column 1: Player list -->
  <div id="playerListContainer">
    <table id="playerTable">
      <thead>
        <tr>
          <th>Players</th>
          <th style="width:120px;">&nbsp;</th>
        </tr>
      </thead>
      <tbody id="playerList"></tbody>
    </table>
  </div>

  <!-- Column 2: Budget + Save/Clear button -->
  <div class="budget-column">
    <table id="budgetTable">
      <thead>
        <tr>
          <th>Coach</th>
          <th>Budget</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button id="saveClearBtn" class="submit-btn">
      Save and Clear
    </button>
  </div>

  <!-- Column 3: Live bids -->
  <div class="bids-column">
    <div id="commishBoard" class="dashboard" style="min-height: 50px;"></div>

    <button id="clearBidsBtn"
            class="submit-btn"
            style="margin-top: 10px;">
      Clear All Bids
    </button>
  </div>

</div>



<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, get, push, child,onValue, remove,set ,update} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBdFLO9Pt8toDPfq3VUFEjMSfghi47tdio",
  authDomain: "spldraft.firebaseapp.com",
  databaseURL: "https://spldraft-default-rtdb.firebaseio.com",
  projectId: "spldraft",
  storageBucket: "spldraft.firebasestorage.app",
  messagingSenderId: "151054562933",
  appId: "1:151054562933:web:a294092e46475fa627ea3c",
  measurementId: "G-V8H70EEQTC"
};
const COACHES = {
  SPL: ["Austin","Dave","Eric","Garrett","Reid","Colin"],
  MLS: ["Hamilton","Jaco","Danny","Tanya","Jake","Freddy"]
};
const app = initializeApp(firebaseConfig);
const database = getDatabase(app);

const bidsContainer = document.getElementById("commishBoard");
let activeTimerInterval = null;
let activeTimerStart = null;
let activeTimerCell = null;

const draftsRef = ref(database, "bids"); // match your submission path

let previousBids = new Set();

// Listen for live updatess
onValue(draftsRef, (snapshot) => {
  bidsContainer.innerHTML = ""; // clear container
  if (!snapshot.exists()) return;

  const drafts = snapshot.val();
  const allBids = [];

  // Collect all bids with coach info
for (const coach in drafts) {
  for (const bidKey in drafts[coach]) {
    const bid = drafts[coach][bidKey].bid;           // number
    const timestamp = drafts[coach][bidKey].timestamp; // timestamp
    const bidId = `${coach}_${bidKey}`;

    allBids.push({ coach, bid, timestamp, bidId });
  }
}


  // Sort bids descending by value
allBids.sort((a, b) => {
  if (b.bid !== a.bid) return b.bid - a.bid;
  return a.timestamp - b.timestamp; // earliest first
});


  // Render bubbles
for (const { coach, bid, bidId } of allBids) {
  const bubble = document.createElement("div");
  bubble.classList.add("submission-bubble");

  if (!previousBids.has(bidId)) {
    bubble.classList.add("new-bubble");
    previousBids.add(bidId);
  }

  bubble.textContent = `${coach} - ${bid} ðŸŸ¡`;
  bidsContainer.appendChild(bubble);
}
});
function calculateBudgets(coaches, playersData) {
  const budgets = {};

  coaches.forEach(coach => {
    let spent = 0;

    Object.values(playersData).forEach(p => {
      if (p.team === coach && p.price) {
        spent += Number(p.price);
      }
    });

    budgets[coach] = 105 - spent;
  });

  return budgets;
}
const saveClearBtn = document.getElementById("saveClearBtn");

saveClearBtn.addEventListener("click", async () => {
  const league = dropdown.value;
  if (!league) return;

  saveClearBtn.disabled = true;
  saveClearBtn.textContent = "Saving...";

  try {
    // 1ï¸âƒ£ Fetch current bids and budgets
    const draftsSnap = await get(ref(database, "bids"));
   
    const drafts = draftsSnap.exists() ? draftsSnap.val() : {};

    // 2ï¸âƒ£ Find the highest bid
    let highestBid = -Infinity;
    let winningCoach = null;
    for (const coach in drafts) {
      for (const bidKey in drafts[coach]) {
        const bidValue = drafts[coach][bidKey].bid;
        if (bidValue > highestBid) {
          highestBid = bidValue;
          winningCoach = coach;
        }
      }
    }

    if (!winningCoach) throw new Error("No bids found!");

    // 3ï¸âƒ£ Subtract highest bid from coach budget


    // 4ï¸âƒ£ Get selected player
    const selectedPlayerSnap = await get(ref(database, "selectedPlayer"));
    const selectedPlayer = selectedPlayerSnap.val();
    if (!selectedPlayer) throw new Error("No player selected");


    await update(ref(db, `players/${league}/${selectedPlayer.name}`), {
  team: winningCoach,
  status: "Locked",
  price: highestBid
});




    // 7ï¸âƒ£ Send bids to Google Sheets
    const bidsArray = [];
    for (const coach in drafts) {
      for (const bidKey in drafts[coach]) {
        bidsArray.push({ coach, bid: drafts[coach][bidKey].bid });
      }
    }
    if (bidsArray.length) {
      fetch("https://script.google.com/macros/s/AKfycbxWWoX0XVg1yHgHkvC3OaJzlNXceDbC_FRUbeJitQk2K9UyMA_rJNYn3D-jatY_qGmN/exec", {
        method: "POST",
        body: JSON.stringify({
          league,
          player: { name: selectedPlayer.name, role: selectedPlayer.role },
          bids: bidsArray
        })
      }).then(res => res.text()).then(console.log).catch(console.error);
    }

    // 8ï¸âƒ£ Clear all bids from Firebase
    await remove(ref(database, "bids"));




    // ðŸ”Ÿ Clear selected player div
    selectedPlayerDiv.style.display = "none";

  } catch (err) {
    console.error("Error in Save and Clear:", err);
  } finally {
    saveClearBtn.disabled = false;
    saveClearBtn.textContent = "Save and Clear";
  }
});





const dropdown = document.getElementById("dashboardDropdown");
const budgetTableBody = document.querySelector("#budgetTable tbody");
const leagueColors = { "": "#7f8c8d", "SPL": "orangered", "MLS": "teal" };

const db = getDatabase();
const leagueRef = ref(db, "currentLeague");

// Listen for league changes from Firebase
onValue(leagueRef, (snapshot) => {
  const league = snapshot.val();
  if (!league) return;

  // Update dropdown state
  dropdown.value = league;
  dropdown.style.backgroundColor = leagueColors[league] || leagueColors[""];

  // Listen to that league's budgets
 

});

// Dropdown updates currentLeague in Firebase
dropdown.addEventListener("change", () => {
  const league = dropdown.value;
  dropdown.style.backgroundColor = leagueColors[league] || leagueColors[""];
  set(leagueRef, league); // save to Firebase
});

// Render table helper
function renderBudgetTable(coaches, highlightCoach = null) {
  budgetTableBody.innerHTML = "";

  Object.entries(coaches)
    .sort((a, b) => b[1] - a[1]) // highest budget first
    .forEach(([coach, budget]) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${coach}</td><td>${budget}</td>`;
      if (coach === highlightCoach) tr.classList.add("highlight-row");
      budgetTableBody.appendChild(tr);
    });
}

const playerListBody = document.getElementById("playerList"); // <--- add this

let currentPlayersListener = null;
const playerTable = document.getElementById("playerTable"); // define this




onValue(leagueRef, (snapshot) => {
  const league = snapshot.val();
  if (!league) return;

  // Update table header color
  const thead = playerTable.querySelector("thead");
  thead.style.backgroundColor = leagueColors[league] || leagueColors[""];

  // Remove previous listener
  if (currentPlayersListener) currentPlayersListener();

  // Listen to players for this league
  const playersRef = ref(db, `players/${league}`);
currentPlayersListener = onValue(playersRef, (snap) => {
  const playersData = snap.val();
  if (!playersData) return;

const coaches = COACHES[league];


  const budgets = calculateBudgets(coaches, playersData);

  // Filter out locked players for available list
  const availablePlayers = Object.fromEntries(
    Object.entries(playersData).filter(([name, stats]) => stats.status !== "Locked")
  );

  renderPlayersTable(availablePlayers, league); // only free/restricted
  renderCharCountTables(availablePlayers);     // only free/restricted
  renderBudgetTable(budgets);
  renderDraftedTableFull(coaches, playersData, league); // full table still uses all players
});


});

function renderPlayersTable(playersData, league) {
  playerListBody.innerHTML = "";

  const playersArray = Object.entries(playersData)
    .map(([name, stats]) => ({ name, ...stats }))
    .sort((a, b) => (a.order || 0) - (b.order || 0));

  playersArray.forEach(player => {
    const tr = document.createElement("tr");

    const nameTd = document.createElement("td");
    nameTd.textContent = player.name;

    const timerTd = document.createElement("td");
    timerTd.textContent = ""; // empty until selected

    tr.appendChild(nameTd);
    tr.appendChild(timerTd);

    tr.addEventListener("click", () => {
      // Clear previous selection + buttons
      playerListBody.querySelectorAll("tr").forEach(row => {
        row.classList.remove("selected");
        row.querySelector("td:last-child").innerHTML = "";
      });

      tr.classList.add("selected");

      // Save selected player in Firebase
      set(ref(db, "selectedPlayer"), {
        league: league,
        name: player.name
      });

      // Create Start button
      const startBtn = document.createElement("button");
      startBtn.textContent = "Start";
      startBtn.style.padding = "4px 8px";
      startBtn.style.cursor = "pointer";


  startBtn.addEventListener("click", (e) => {
    e.stopPropagation();

    set(ref(db, "timer"), {
      league: league,
      player: player.name,
      startTime: Date.now(),
      running: true
    });
  });


      timerTd.appendChild(startBtn);
      timerTd.appendChild(timeDisplay);
    });

    playerListBody.appendChild(tr);
  });
}


const selectedPlayerDiv = document.getElementById("showSelectedPlayer");
const selectedPlayerRef = ref(db, "selectedPlayer");


onValue(selectedPlayerRef, async snapshot => {
  const sel = snapshot.val();
  if (!sel) { 
    selectedPlayerDiv.style.display = "none"; 
    return; 
  }

  try {
    const playerSnap = await get(ref(db, `players/${sel.league}/${sel.name}`));
    if (!playerSnap.exists()) { 
      selectedPlayerDiv.style.display = "none"; 
      return; 
    }

    const stats = playerSnap.val();
    selectedPlayerDiv.style.display = "block";

    // Toggle restricted class
    if (stats.status === "Restricted") {
      selectedPlayerDiv.classList.add("Restricted");
    } else {
      selectedPlayerDiv.classList.remove("Restricted");
    }

    // Build the HTML
    let restrictedLine = "";
    if (stats.status === "Restricted") {
      // Price with ðŸŸ¡ emoji, rounded if needed
      const price = stats.price || 0;
      restrictedLine = `<div style="margin-top:4px; font-size:30px; text-align:center; font-weight:bold; color:#ffd700;">
                          Restricted: ${stats.team || "Unknown"} - Min Bid: ðŸŸ¡${Math.ceil(stats.price * 1.1)}
                        </div>`;

    }

    selectedPlayerDiv.innerHTML = `
      <h2>${sel.name} - Career Stats</h2>
      ${restrictedLine}
      <div class="player-stats">
        <div><u>Games</u><br>${stats.games}</div>
        <div><u>Win %</u><br>${stats.winp}</div>
        <div><u>Goals/Game</u><br>${stats.goals}</div>
        <div><u>MS-SS/Game</u><br>${stats.msss}</div>
        <div><u>SI</u><br>${stats.si}</div>
        <div><u>Impact</u><br>${stats.impact}</div>
        <div><u>+/-</u><br>${stats.pm}</div>
      </div>
    `;
  } catch (err) {
    console.error(err);
    selectedPlayerDiv.style.display = "none";
  }
});



const draftedContainer = document.getElementById("draftedRostersContainer");

let draftedListener = null;



// Render full table with blank rows if needed
// Render full table with blank rows if needed
function renderDraftedTableFull(coaches, playersData, league) {
  const draftedContainer = document.getElementById("draftedRostersContainer"); // update if your container id is different
  draftedContainer.innerHTML = "";

  // Map each coach to their captains and sidekicks
  const teamMap = {};
  Object.entries(playersData).forEach(([name, p]) => {
    if (!p.team) return;
    if (!teamMap[p.team]) teamMap[p.team] = { captains: [], sidekicks: [] };
    if (p.role === "Captain") teamMap[p.team].captains.push({ name, ...p });
    else teamMap[p.team].sidekicks.push({ name, ...p });
  });

  const table = document.createElement("table");
  table.className = "drafted-rosters-table";

  // Header
  const thead = document.createElement("thead");
  const headerRow = document.createElement("tr");
  coaches.forEach(c => {
    const th = document.createElement("th");
    th.textContent = c;
    headerRow.appendChild(th);
  });
  headerRow.style.backgroundColor = leagueColors[league] || "#7f8c8d";
  headerRow.style.color = "#fff";
  thead.appendChild(headerRow);
  table.appendChild(thead);

  // 2 rows for captains, 5 rows for sidekicks
  for (let row = 0; row < 7; row++) {
    const tr = document.createElement("tr");

    coaches.forEach(coach => {
      const td = document.createElement("td");
      const team = teamMap[coach] || { captains: [], sidekicks: [] };
      let player;

      if (row < 2) {
        // First 2 rows = captains
        player = team.captains[row];
      } else {
        // Next 5 rows = sidekicks
        player = team.sidekicks[row - 2];
      }

      if (player) {
        td.textContent = player.name;
        if (player.status === "Restricted") {
          td.innerHTML = `${player.name} - <b>${Math.ceil(player.price*1.1)}</b>`;
          td.style.color = "#3498db";
        } else td.style.color = "#000";
      }

      tr.appendChild(td);
    });

    table.appendChild(tr);
  }

  draftedContainer.appendChild(table);
}



const charOrder = [
  "BJ",
  "Bowser",
  "Daisy",
  "Diddy",
  "DK",
  "Luigi",
  "Mario",
  "Peach",
  "Petey",
  "Wario",
  "Waluigi",
  "Yoshi",
  "Birdo",
  "Dry Bones",
  "Boo",
  "Koopa",
  "Hammer Bro",
  "Monty",
  "Shy Guy",
  "Toad"
]
function renderCharCountTables(playersData) {
  const charCountContainer = document.getElementById("charCountContainer"); // a wrapper div
  if (!charCountContainer) return;

  const counts = {};

  // Count remaining players by their char field
  Object.values(playersData).forEach(player => {
    const char = player.char || "Unknown";
    counts[char] = (counts[char] || 0) + 1;
  });

  // Split charOrder into two arrays
  const firstHalf = charOrder.slice(0, 12);
  const secondHalf = charOrder.slice(12);

  charCountContainer.innerHTML = ""; // clear previous tables

  [ firstHalf, secondHalf ].forEach((charGroup, index) => {
  const table = document.createElement("table");
  table.classList.add("char-count-table");

  const thead = document.createElement("thead");
  const trHead = document.createElement("tr");

  // Set different header colors
  const headerColor = index === 0 ? "#e74c3c" : "#3498db"; // first table orange, second table blue

  charGroup.forEach(char => {
    const th = document.createElement("th");
    th.textContent = char;
    th.style.backgroundColor = headerColor;
    trHead.appendChild(th);
  });

  thead.appendChild(trHead);
  table.appendChild(thead);

  const tbody = document.createElement("tbody");
  const trBody = document.createElement("tr");

  charGroup.forEach(char => {
    const td = document.createElement("td");
    td.textContent = counts[char] || 0;
    trBody.appendChild(td);
  });

  tbody.appendChild(trBody);
  table.appendChild(tbody);

  charCountContainer.appendChild(table);
});
}

const clearBidsBtn = document.getElementById("clearBidsBtn");

clearBidsBtn.addEventListener("click", async () => {
  if (!confirm("Are you sure you want to clear all bids?")) return;

  clearBidsBtn.disabled = true;
  clearBidsBtn.textContent = "Clearing...";

  try {
    const draftsRef = ref(database, "bids");
    await remove(draftsRef); // removes all bids
    previousBids.clear();    // reset new-bubble tracking
    bidsContainer.innerHTML = ""; // clear UI immediately
    console.log("All bids cleared!");
  } catch (err) {
    console.error("Error clearing bids:", err);
  } finally {
    clearBidsBtn.disabled = false;
    clearBidsBtn.textContent = "Clear All Bids";
  }
});

let timerInterval = null;
const countdownSeconds = 60;
const RESTRICTED_WINDOW = 30;

onValue(ref(db, "timer"), (snapshot) => {
  const data = snapshot.val();

  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }

  if (!data || !data.running) {
    document.getElementById("timerClock").textContent = countdownSeconds;
    document.getElementById("restrictedTimerContainer").style.display = "none";
    return;
  }

  const start = data.startTime;

  timerInterval = setInterval(async () => {
    const elapsed = Math.floor((Date.now() - start) / 1000);
    let remaining = countdownSeconds - elapsed;
    if (remaining < 0) remaining = 0;

    document.getElementById("timerClock").textContent = remaining;

    try {
      const selSnap = await get(ref(db, "selectedPlayer"));
      if (!selSnap.exists()) return;
      const sel = selSnap.val();

      const playerSnap = await get(ref(db, `players/${sel.league}/${sel.name}`));
      if (!playerSnap.exists()) return;
      const player = playerSnap.val();

      // Restricted timer
      // Restricted timer
if (player.status === "Restricted") {

  // Get bids + highest bid
  const bidSnap = await get(ref(db, "bids"));
  const bidsData = bidSnap.exists() ? bidSnap.val() : null;

  let highestBid = 0;
  if (bidsData) {
    for (const coach in bidsData) {
      for (const bidKey in bidsData[coach]) {
        const val = Number(bidsData[coach][bidKey].bid);
        if (val > highestBid) highestBid = val;
      }
    }
  }

  const minFreeBid = Math.ceil(player.price * 1.1);

      // ðŸ”“ Free instantly if bid is high enough
      if (highestBid >= minFreeBid) {
      await update(ref(db, `players/${sel.league}/${sel.name}`), {
        status: "Free",
        team: "",
        price: ""
      });


        document.getElementById("restrictedTimerContainer").style.display = "none";
        return;
      }

      // Otherwise continue restricted countdown
      let restrictedRemaining = RESTRICTED_WINDOW - elapsed;
      if (restrictedRemaining < 0) restrictedRemaining = 0;

      document.getElementById("restrictedTimerContainer").style.display = "flex";
      document.getElementById("restrictedTimerClock").textContent =
        restrictedRemaining + "s";

      // Lock if time expires with no bids
      if (restrictedRemaining === 0 && highestBid === 0) {
        await update(ref(db, `players/${sel.league}/${sel.name}`), {
          status: "Locked"
        });

        await update(ref(db, "timer"), { running: false });
        document.getElementById("restrictedTimerContainer").style.display = "none";
      }

    } else {
      document.getElementById("restrictedTimerContainer").style.display = "none";
    }


    } catch (err) {
      console.error(err);
    }

    if (remaining === 0) {
      clearInterval(timerInterval);
      timerInterval = null;
    }

  }, 1000);
});





/*
const splBudgetsRef = ref(database, "budgets/SPL");
set(splBudgetsRef, {
  Garrett: 105,
  Austin: 105,
  Danny: 105,
  Eric: 105,
  Dave: 105,
  Jaco: 105,
});
const mlsBudgetsRef = ref(database, "budgets/MLS");
set(mlsBudgetsRef, {
  Colin: 105,
  Tanya: 105,
  Freddy: 105,
  Hamilton: 105,
  Jake: 105,
  Reid: 105,
});
*/



</script>

